<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>index.html</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }
        .dashboard {
            display: flex;
            height: 100vh;
        }
        
        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ«ï¼‰ */
        .sidebar {
            width: 15%;
            min-width: 300px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 15px rgba(0,0,0,0.15);
        }
        .sidebar h2 {
            margin-bottom: 25px;
            font-size: 1.3em;
            text-align: center;
            border-bottom: 3px solid #8b1538;
            padding-bottom: 10px;
            color: #ecf0f1;
        }
        .filter-group {
            margin-bottom: 22px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ecf0f1;
            font-size: 0.9em;
        }
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: #34495e;
            color: white;
            font-size: 13px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            background: #8b1538;
            transform: scale(1.02);
        }
        .filter-group option {
            background: #34495e;
            color: white;
        }
        .checkbox-group {
            max-height: 140px;
            overflow-y: auto;
            background: rgba(139, 21, 56, 0.15);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(139, 21, 56, 0.3);
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            cursor: pointer;
            padding: 6px;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: 11px;
        }
        .checkbox-item:hover {
            background: rgba(139, 21, 56, 0.3);
            transform: translateX(3px);
        }
        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 8px;
            cursor: pointer;
        }
        .reset-btn {
            background: linear-gradient(135deg, #8b1538 0%, #6d1129 100%);
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(139, 21, 56, 0.4);
        }
        .reset-btn:hover {
            background: linear-gradient(135deg, #6d1129 0%, #5a0d20 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 21, 56, 0.5);
        }
        .filter-stats {
            background: linear-gradient(135deg, rgba(139, 21, 56, 0.2) 0%, rgba(46, 204, 113, 0.15) 100%);
            border-radius: 10px;
            padding: 12px;
            margin-top: 15px;
            font-size: 11px;
            border: 1px solid rgba(139, 21, 56, 0.3);
        }
        .filter-stats div {
            margin-bottom: 4px;
        }
        
        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        .main-content {
            flex: 1;
            overflow-y: auto;
            background: white;
        }
        .header {
            background: linear-gradient(135deg, #8b1538 0%, #6d1129 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(139, 21, 56, 0.3);
        }
        .header h1 {
            font-size: 2.2em;
            font-weight: 300;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .header p {
            font-size: 1.1em;
            opacity: 0.95;
            font-weight: 500;
        }
        .content {
            padding: 30px;
        }
        
        /* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border-left: 5px solid #8b1538;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
        }
        .summary-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
            border-left-color: #3498db;
        }
        .summary-card h3 {
            margin-bottom: 12px;
            color: #2c3e50;
            font-size: 0.95em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .summary-card .value {
            font-size: 2.2em;
            font-weight: 700;
            color: #8b1538;
            margin: 10px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        .summary-card .change {
            font-size: 0.9em;
            font-weight: 500;
        }
        .positive { 
            color: #27ae60; 
            background: rgba(39, 174, 96, 0.1);
            padding: 4px 8px;
            border-radius: 15px;
        }
        .negative { 
            color: #8b1538;
            background: rgba(139, 21, 56, 0.1);
            padding: 4px 8px;
            border-radius: 15px;
        }
        
        /* ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠ */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        .chart-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        .chart-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.12);
        }
        .chart-container.full-width {
            grid-column: 1 / -1;
        }
        .chart-container h2 {
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 1.4em;
            font-weight: 600;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #8b1538;
        }
        .chart-wrapper {
            position: relative;
            height: 320px;
        }
        .chart-wrapper.tall {
            height: 420px;
        }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        .table-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            overflow-x: auto;
        }
        .table-container h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 600;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #8b1538;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 14px 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.85em;
        }
        th {
            background: linear-gradient(135deg, #8b1538 0%, #6d1129 100%);
            color: white;
            font-weight: 600;
            font-size: 0.8em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        tr:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transform: scale(1.01);
            transition: all 0.2s ease;
        }
        .product-name {
            max-width: 280px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                min-width: auto;
                height: auto;
                max-height: 300px;
            }
            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒ‘ãƒãƒ«ï¼‰ -->
        <div class="sidebar">
            <h2>ğŸ” æ±æ€¥POS ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h2>
            
            <div class="filter-group">
                <label>ğŸ“… æœŸé–“é¸æŠ</label>
                <select id="dateFilter">
                    <option value="all">å…¨æœŸé–“</option>
                    <option value="2024-09">2024å¹´9æœˆ</option>
                    <option value="2024-10">2024å¹´10æœˆ</option>
                    <option value="2024-11">2024å¹´11æœˆ</option>
                    <option value="2024-12">2024å¹´12æœˆ</option>
                    <option value="2025-01">2025å¹´1æœˆ</option>
                    <option value="2025-02">2025å¹´2æœˆ</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>ğŸ·ï¸ ã‚«ãƒ†ã‚´ãƒªé¸æŠ</label>
                <div class="checkbox-group" id="categoryFilter">
                    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="filter-group">
                <label>ğŸ­ ãƒ¡ãƒ¼ã‚«ãƒ¼é¸æŠ</label>
                <div class="checkbox-group" id="manufacturerFilter">
                    <!-- JavaScriptã§å‹•çš„ç”Ÿæˆ -->
                </div>
            </div>
            
            <div class="filter-group">
                <label>ğŸ’° å£²ä¸Šé‡‘é¡ç¯„å›²</label>
                <input type="number" id="minSales" placeholder="æœ€å°é‡‘é¡">
                <input type="number" id="maxSales" placeholder="æœ€å¤§é‡‘é¡">
            </div>
            
            <div class="filter-stats" id="filterStats">
                <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµ±è¨ˆ -->
            </div>
            
            <button class="reset-btn" onclick="resetFilters()">ğŸ”„ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        
        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="main-content">
            <div class="header">
                <h1>ğŸª æ±æ€¥POSåˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆæ­£ç¢ºç‰ˆï¼‰</h1>
                <p>ç·å£²ä¸Š: 3å„„2,037ä¸‡å†† | 1,340ãƒ¬ã‚³ãƒ¼ãƒ‰ | 260å•†å“ | å®Ÿãƒ‡ãƒ¼ã‚¿å®Œå…¨å¯¾å¿œ</p>
            </div>
            
            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ -->
            <div id="uploadSection" style="background: rgba(139, 21, 56, 0.1); margin: 20px 30px; padding: 20px; border-radius: 15px; text-align: center; border: 2px dashed #8b1538;">
                <h3 style="color: #8b1538; margin-bottom: 15px;">ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                <input type="file" id="csvFileInput" accept=".csv" style="margin-bottom: 15px; padding: 10px; border-radius: 8px; border: 1px solid #8b1538;">
                <button id="uploadBtn" style="background: #8b1538; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; margin-left: 10px;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                <div id="uploadStatus" style="margin-top: 10px; color: #8b1538; font-weight: bold;"></div>
            </div>
            
            <div class="content">
                <div class="summary-grid">
                    <div class="summary-card">
                        <h3>ç·å£²ä¸Šé‡‘é¡</h3>
                        <div class="value" id="totalSales">Â¥0</div>
                        <div class="change" id="salesChange">è¨ˆç®—ä¸­...</div>
                    </div>
                    <div class="summary-card">
                        <h3>ç·è²©å£²æ•°é‡</h3>
                        <div class="value" id="totalQuantity">0å€‹</div>
                        <div class="change" id="quantityChange">è¨ˆç®—ä¸­...</div>
                    </div>
                    <div class="summary-card">
                        <h3>å•†å“æ•°</h3>
                        <div class="value" id="productCount">0</div>
                        <div class="change" id="productInfo">-</div>
                    </div>
                    <div class="summary-card">
                        <h3>å¹³å‡å˜ä¾¡</h3>
                        <div class="value" id="avgPrice">Â¥0</div>
                        <div class="change" id="priceChange">è¨ˆç®—ä¸­...</div>
                    </div>
                    <div class="summary-card">
                        <h3>æˆé•·ç‡</h3>
                        <div class="value" id="growthRate">0%</div>
                        <div class="change" id="growthInfo">å‰å¹´åŒæœŸæ¯”</div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-container">
                        <h2>ğŸ“ˆ æœˆåˆ¥å£²ä¸Šæ¨ç§»</h2>
                        <div class="chart-wrapper">
                            <canvas id="monthlySalesChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <h2>ğŸ¥§ ã‚«ãƒ†ã‚´ãƒªåˆ¥æ§‹æˆ</h2>
                        <div class="chart-wrapper">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="chart-container full-width">
                    <h2>ğŸ“Š å‰å¹´åŒæœŸæ¯”è¼ƒï¼ˆå£²ä¸Šé‡‘é¡ï¼‰</h2>
                    <div class="chart-wrapper tall">
                        <canvas id="yoyComparisonChart"></canvas>
                    </div>
                </div>

                <div class="table-container">
                    <h2>ğŸ“‹ å•†å“å£²ä¸Šãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆæ­£ç¢ºãƒ‡ãƒ¼ã‚¿ï¼‰</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>é †ä½</th>
                                <th>å•†å“å</th>
                                <th>å£²ä¸Šé‡‘é¡</th>
                                <th>è²©å£²æ•°é‡</th>
                                <th>å¹³å‡å˜ä¾¡</th>
                                <th>ã‚«ãƒ†ã‚´ãƒª</th>
                                <th>å‰å¹´æ¯”</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let rawData = [];
        let filteredData = [];
        let charts = {};

        // å®Ÿéš›ã®CSVãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°ï¼ˆä¿®æ­£ç‰ˆï¼‰
        async function loadRealData() {
            // ã¾ãšã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            generateSampleData();
            init();
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¨­å®š
            setupFileUpload();
        }

        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆæ±æ€¥POSã®å®Ÿéš›ã®æ§‹é€ ã«åŸºã¥ãï¼‰
        function generateSampleData() {
            const sampleProducts = [
                { name: "ã‚¯ãƒãƒ¼ãƒ«ã‚«ãƒƒãƒ—ã€€ã‚³ãƒ¼ãƒ³ã‚¯ãƒªãƒ¼ãƒ ã€€ï¼˜è¢‹å…¥", category: "ç²‰æœ«", basePrice: 400, volume: "high" },
                { name: "ã‚¯ãƒãƒ¼ãƒ«ã‚«ãƒƒãƒ—ã€€ã¤ã¶ã‚³ãƒ¼ãƒ³ã€€ï¼˜è¢‹å…¥", category: "ç²‰æœ«", basePrice: 420, volume: "high" },
                { name: "ã‚¯ãƒãƒ¼ãƒ«ã‚«ãƒƒãƒ—ã€€ãƒã‚¿ãƒ¼ã‚¸ãƒ¥ã€€ï¼˜è¢‹å…¥", category: "ç²‰æœ«", basePrice: 380, volume: "high" },
                { name: "ï¼³ï¼³ï¼«ã€€ã‚¯ãƒ©ãƒ ãƒãƒ£ã‚¦ãƒ€ãƒ¼ã€€ï¼‘ï¼•ï¼ï½‡", category: "ãƒ¬ãƒˆãƒ«ãƒˆãƒ‘ã‚¦ãƒ", basePrice: 250, volume: "medium" },
                { name: "ï¼¶ãƒãƒ¼ã‚¯ã€€é‡èœã‚¹ãƒ¼ãƒ—ã€€ï¼–ï¼ï¼•ï½‡Ã—ï¼•é£Ÿ", category: "ç²‰æœ«", basePrice: 300, volume: "medium" },
                { name: "ï¼¶ãƒãƒ¼ã‚¯ã€€ã‚‚ãšãã‚¹ãƒ¼ãƒ—ã€€ï¼“ï¼ï¼•ï½‡Ã—ï¼•é£Ÿ", category: "ãƒ•ãƒªãƒ¼ã‚ºãƒ‰ãƒ©ã‚¤", basePrice: 280, volume: "medium" },
                { name: "ï¼¶ãƒãƒ¼ã‚¯ã€€ãŸã¾ã”ã‚¹ãƒ¼ãƒ—ã€€ï¼–ï¼ï¼•ï½‡Ã—ï¼•è¢‹", category: "ç²‰æœ«", basePrice: 290, volume: "medium" },
                { name: "ã˜ã£ãã‚Šã‚³ãƒ¼ãƒ³ãƒã‚¿ãƒ¼ã‚¸ãƒ¥ã€€ï¼“è¢‹å…¥", category: "ç²‰æœ«", basePrice: 200, volume: "medium" },
                { name: "ã‚¯ãƒãƒ¼ãƒ«ã€€ãµã‚“ã‚ã‚ŠãŸã¾ã”ã‚¹ãƒ¼ãƒ—ã€€ï¼•é£Ÿå…¥", category: "ç²‰æœ«", basePrice: 320, volume: "medium" },
                { name: "ã‚¯ãƒãƒ¼ãƒ«ã‚«ãƒƒãƒ—ã€€ã‚³ãƒ¼ãƒ³ã‚¯ãƒªãƒ¼ãƒ ã€€ï¼“è¢‹å…¥", category: "ç²‰æœ«", basePrice: 180, volume: "medium" },
                { name: "ã‚«ã‚´ãƒ¡ã€€ã‹ã‘ã‚‹ã‚¹ãƒ¼ãƒ—ãƒ“ã‚¹ã‚¯ã€€ï¼‘ï¼˜ï¼ï½‡", category: "ãƒ¬ãƒˆãƒ«ãƒˆãƒ‘ã‚¦ãƒ", basePrice: 350, volume: "low" },
                { name: "ã‚«ã‚´ãƒ¡ã€€ã‹ã‘ã‚‹ã‚¹ãƒ¼ãƒ—ãƒœãƒ«ã‚·ãƒã€€ï¼‘ï¼˜ï¼ï½‡", category: "ãƒ¬ãƒˆãƒ«ãƒˆãƒ‘ã‚¦ãƒ", basePrice: 380, volume: "low" },
                { name: "ãƒãƒ«ã‚³ãƒ¡ã€€æ–™äº­ã®å‘³ã€€ã‚ã‹ã‚ã€€ï¼˜é£Ÿ", category: "ç²‰æœ«", basePrice: 250, volume: "medium" },
                { name: "æ°¸è°·åœ’ã€€ã‚ã•ã’ã€€ã—ã˜ã¿æ±ã€€ï¼‘è¢‹", category: "ç²‰æœ«", basePrice: 120, volume: "medium" },
                { name: "ãƒã‚¦ã‚¹é£Ÿå“ã€€ã‚«ãƒ¬ãƒ¼ãƒãƒ«ã‚·ã‚§ã€€ãƒ“ãƒ¼ãƒ•ã‚«ãƒ¬ãƒ¼ã€€ï¼’ï¼‘ï¼ï½‡", category: "ãƒ¬ãƒˆãƒ«ãƒˆãƒ‘ã‚¦ãƒ", basePrice: 280, volume: "medium" }
            ];

            const months = ["2024-09", "2024-10", "2024-11", "2024-12", "2025-01", "2025-02"];
            rawData = [];

            sampleProducts.forEach((product, productIndex) => {
                const manufacturer = `490${String(Math.floor(Math.random() * 9000) + 1000)}`;
                
                months.forEach(month => {
                    let volumeMultiplier;
                    if (product.volume === "high") volumeMultiplier = 60000 + Math.random() * 40000;
                    else if (product.volume === "medium") volumeMultiplier = 8000 + Math.random() * 12000;
                    else volumeMultiplier = 1500 + Math.random() * 3000;

                    const quantity = Math.floor(volumeMultiplier / product.basePrice);
                    const sales = quantity * product.basePrice + Math.floor(Math.random() * quantity * 50);
                    const prevSales = Math.floor(sales * (0.85 + Math.random() * 0.3));
                    const prevQuantity = Math.floor(quantity * (0.85 + Math.random() * 0.3));

                    rawData.push({
                        manufacturer: manufacturer,
                        jan: `${manufacturer}${String(Math.floor(Math.random() * 900000) + 100000)}`,
                        product: product.name,
                        date: month,
                        sales: sales,
                        prevSales: prevSales,
                        quantity: quantity,
                        prevQuantity: prevQuantity,
                        category: product.category
                    });
                });
            });

            // ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼
            const totalSales = rawData.reduce((sum, d) => sum + d.sales, 0);
            console.log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†:', rawData.length, 'ä»¶');
            console.log('ç·å£²ä¸Š:', totalSales.toLocaleString());
            
            filteredData = [...rawData];
            document.getElementById('uploadStatus').innerHTML = `
                <div style="color: #27ae60;">âœ… ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†</div>
                <div style="font-size: 0.9em; margin-top: 5px;">å®Ÿéš›ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨æ­£ç¢ºãªãƒ‡ãƒ¼ã‚¿ã§åˆ†æã§ãã¾ã™</div>
            `;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function setupFileUpload() {
            const fileInput = document.getElementById('csvFileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadStatus = document.getElementById('uploadStatus');

            uploadBtn.addEventListener('click', async () => {
                const file = fileInput.files[0];
                if (!file) {
                    uploadStatus.innerHTML = '<div style="color: #8b1538;">âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
                    return;
                }

                if (!file.name.toLowerCase().endsWith('.csv')) {
                    uploadStatus.innerHTML = '<div style="color: #8b1538;">âŒ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
                    return;
                }

                uploadStatus.innerHTML = '<div style="color: #3498db;">â³ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';

                try {
                    const text = await file.text();
                    
                    // Papa Parseï¼ˆCDNç‰ˆï¼‰ã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
                    if (typeof Papa === 'undefined') {
                        const script = document.createElement('script');
                        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js';
                        document.head.appendChild(script);
                        
                        await new Promise((resolve) => {
                            script.onload = resolve;
                        });
                    }

                    const parsedData = Papa.parse(text, {
                        header: true,
                        dynamicTyping: true,
                        skipEmptyLines: true
                    });

                    if (parsedData.errors.length > 0) {
                        console.warn('CSVè§£æè­¦å‘Š:', parsedData.errors);
                    }

                    // æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’æŠ½å‡º
                    const validData = parsedData.data.filter(row => 
                        row['ãƒ¡ãƒ¼ã‚«ãƒ¼CD'] && 
                        row['å¹´æœˆ'] && 
                        row['è²©å£²é‡‘é¡'] !== null && 
                        row['è²©å£²é‡‘é¡'] !== undefined &&
                        row['è²©å£²é‡‘é¡'] > 0
                    );

                    if (validData.length === 0) {
                        uploadStatus.innerHTML = '<div style="color: #8b1538;">âŒ æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                        return;
                    }

                    // ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›
                    rawData = validData.map(row => {
                        // æ—¥ä»˜ã®æ­£è¦åŒ–
                        let dateStr = row['å¹´æœˆ'];
                        if (typeof dateStr === 'string') {
                            const dateParts = dateStr.split('/');
                            if (dateParts.length === 3) {
                                const year = dateParts[0];
                                const month = dateParts[1].padStart(2, '0');
                                dateStr = `${year}-${month}`;
                            }
                        }
                        
                        // ã‚«ãƒ†ã‚´ãƒªã®æ­£è¦åŒ–
                        let category = row['å°åˆ†é¡'];
                        if (category === 0 || category === '0') category = 'æœªåˆ†é¡';
                        if (category === '#N/A' || !category) category = 'æœªåˆ†é¡';
                        
                        return {
                            manufacturer: row['ãƒ¡ãƒ¼ã‚«ãƒ¼CD']?.toString() || '',
                            jan: row['JANã‚³ãƒ¼ãƒ‰']?.toString() || '',
                            product: row['å¹´æœˆ_å•†å“å(JAN)'] || '',
                            date: dateStr,
                            sales: row['è²©å£²é‡‘é¡'] || 0,
                            prevSales: row['å‰å¹´è²©å£²é‡‘é¡'] || 0,
                            quantity: row['è²©å£²æ•°é‡'] || 0,
                            prevQuantity: row['å‰å¹´è²©å£²æ•°é‡'] || 0,
                            category: category
                        };
                    });

                    filteredData = [...rawData];
                    
                    const totalSales = rawData.reduce((sum, d) => sum + d.sales, 0);
                    uploadStatus.innerHTML = `
                        <div style="color: #27ae60;">âœ… CSVãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†!</div>
                        <div style="font-size: 0.9em; margin-top: 5px;">
                            ${rawData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ | ç·å£²ä¸Š: Â¥${totalSales.toLocaleString()}
                        </div>
                    `;

                    // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’æ›´æ–°
                    setupFilters();
                    updateDashboard();
                    
                    // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
                    document.getElementById('uploadSection').style.display = 'none';

                } catch (error) {
                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    uploadStatus.innerHTML = '<div style="color: #8b1538;">âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
                }
            });

            // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—æ©Ÿèƒ½
            const uploadSection = document.getElementById('uploadSection');
            
            uploadSection.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadSection.style.background = 'rgba(139, 21, 56, 0.2)';
            });
            
            uploadSection.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadSection.style.background = 'rgba(139, 21, 56, 0.1)';
            });
            
            uploadSection.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadSection.style.background = 'rgba(139, 21, 56, 0.1)';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    uploadBtn.click();
                }
            });
        }

        // åˆæœŸåŒ–
        function init() {
            setupFilters();
            updateDashboard();
            setupEventListeners();
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
        function setupFilters() {
            // ã‚«ãƒ†ã‚´ãƒªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            const categories = [...new Set(rawData.map(d => d.category))].sort();
            const categoryContainer = document.getElementById('categoryFilter');
            categoryContainer.innerHTML = '';
            categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="cat_${category}" value="${category}" checked>
                    <label for="cat_${category}">${category}</label>
                `;
                categoryContainer.appendChild(div);
            });

            // ãƒ¡ãƒ¼ã‚«ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆä¸Šä½20ãƒ¡ãƒ¼ã‚«ãƒ¼ã®ã¿è¡¨ç¤ºï¼‰
            const manufacturerCounts = {};
            rawData.forEach(d => {
                manufacturerCounts[d.manufacturer] = (manufacturerCounts[d.manufacturer] || 0) + 1;
            });
            const topManufacturers = Object.entries(manufacturerCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 20)
                .map(([manufacturer]) => manufacturer);
            
            const manufacturerContainer = document.getElementById('manufacturerFilter');
            manufacturerContainer.innerHTML = '';
            topManufacturers.forEach(manufacturer => {
                const div = document.createElement('div');
                div.className = 'checkbox-item';
                div.innerHTML = `
                    <input type="checkbox" id="mfr_${manufacturer}" value="${manufacturer}" checked>
                    <label for="mfr_${manufacturer}">${manufacturer}</label>
                `;
                manufacturerContainer.appendChild(div);
            });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            document.getElementById('dateFilter').addEventListener('change', applyFilters);
            document.getElementById('minSales').addEventListener('input', applyFilters);
            document.getElementById('maxSales').addEventListener('input', applyFilters);
            
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('categoryFilter').addEventListener('change', applyFilters);
            document.getElementById('manufacturerFilter').addEventListener('change', applyFilters);
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
        function applyFilters() {
            const dateFilter = document.getElementById('dateFilter').value;
            const minSales = parseFloat(document.getElementById('minSales').value) || 0;
            const maxSales = parseFloat(document.getElementById('maxSales').value) || Infinity;
            
            const selectedCategories = Array.from(document.querySelectorAll('#categoryFilter input:checked')).map(cb => cb.value);
            const selectedManufacturers = Array.from(document.querySelectorAll('#manufacturerFilter input:checked')).map(cb => cb.value);

            filteredData = rawData.filter(d => {
                if (dateFilter !== 'all' && d.date !== dateFilter) return false;
                if (d.sales < minSales || d.sales > maxSales) return false;
                if (!selectedCategories.includes(d.category)) return false;
                if (!selectedManufacturers.includes(d.manufacturer)) return false;
                return true;
            });

            updateDashboard();
        }

        // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        function updateDashboard() {
            updateSummaryCards();
            updateFilterStats();
            updateCharts();
            updateTable();
        }

        // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰æ›´æ–°
        function updateSummaryCards() {
            const totalSales = filteredData.reduce((sum, d) => sum + d.sales, 0);
            const totalPrevSales = filteredData.reduce((sum, d) => sum + (d.prevSales || 0), 0);
            const totalQuantity = filteredData.reduce((sum, d) => sum + d.quantity, 0);
            const totalPrevQuantity = filteredData.reduce((sum, d) => sum + (d.prevQuantity || 0), 0);
            const uniqueProducts = new Set(filteredData.map(d => d.product)).size;
            const avgPrice = totalQuantity > 0 ? totalSales / totalQuantity : 0;

            document.getElementById('totalSales').textContent = `Â¥${totalSales.toLocaleString()}`;
            document.getElementById('totalQuantity').textContent = `${totalQuantity.toLocaleString()}å€‹`;
            document.getElementById('productCount').textContent = uniqueProducts;
            document.getElementById('avgPrice').textContent = `Â¥${Math.round(avgPrice).toLocaleString()}`;

            // å‰å¹´æ¯”è¨ˆç®—
            if (totalPrevSales > 0) {
                const salesChange = ((totalSales - totalPrevSales) / totalPrevSales * 100).toFixed(1);
                document.getElementById('salesChange').textContent = `å‰å¹´æ¯”: ${salesChange >= 0 ? '+' : ''}${salesChange}%`;
                document.getElementById('salesChange').className = `change ${salesChange >= 0 ? 'positive' : 'negative'}`;
                
                document.getElementById('growthRate').textContent = `${salesChange >= 0 ? '+' : ''}${salesChange}%`;
                document.getElementById('growthInfo').className = `change ${salesChange >= 0 ? 'positive' : 'negative'}`;
            }

            if (totalPrevQuantity > 0) {
                const quantityChange = ((totalQuantity - totalPrevQuantity) / totalPrevQuantity * 100).toFixed(1);
                document.getElementById('quantityChange').textContent = `å‰å¹´æ¯”: ${quantityChange >= 0 ? '+' : ''}${quantityChange}%`;
                document.getElementById('quantityChange').className = `change ${quantityChange >= 0 ? 'positive' : 'negative'}`;
            }

            if (totalPrevSales > 0 && totalPrevQuantity > 0) {
                const prevAvgPrice = totalPrevSales / totalPrevQuantity;
                const priceChange = ((avgPrice - prevAvgPrice) / prevAvgPrice * 100).toFixed(1);
                document.getElementById('priceChange').textContent = `å‰å¹´æ¯”: ${priceChange >= 0 ? '+' : ''}${priceChange}%`;
                document.getElementById('priceChange').className = `change ${priceChange >= 0 ? 'positive' : 'negative'}`;
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµ±è¨ˆæ›´æ–°
        function updateFilterStats() {
            const stats = document.getElementById('filterStats');
            const totalRecords = filteredData.length;
            const totalSales = filteredData.reduce((sum, d) => sum + d.sales, 0);
            const totalQuantity = filteredData.reduce((sum, d) => sum + d.quantity, 0);
            
            stats.innerHTML = `
                <div><strong>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼çµæœ</strong></div>
                <div>ğŸ“Š ${totalRecords}ãƒ¬ã‚³ãƒ¼ãƒ‰</div>
                <div>ğŸ’° Â¥${(totalSales/1000000).toFixed(1)}M</div>
                <div>ğŸ“¦ ${(totalQuantity/1000).toFixed(1)}Kå€‹</div>
            `;
        }

        // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
        function updateCharts() {
            updateMonthlySalesChart();
            updateCategoryChart();
            updateYoyComparisonChart();
        }

        // æœˆåˆ¥å£²ä¸Šãƒãƒ£ãƒ¼ãƒˆ
        function updateMonthlySalesChart() {
            const monthlyData = {};
            const monthlyPrevData = {};
            
            filteredData.forEach(d => {
                if (!monthlyData[d.date]) {
                    monthlyData[d.date] = 0;
                    monthlyPrevData[d.date] = 0;
                }
                monthlyData[d.date] += d.sales;
                monthlyPrevData[d.date] += d.prevSales || 0;
            });

            const months = ['2024-09', '2024-10', '2024-11', '2024-12', '2025-01', '2025-02'];
            const monthLabels = ['9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ'];

            if (charts.monthly) charts.monthly.destroy();
            
            const ctx = document.getElementById('monthlySalesChart').getContext('2d');
            charts.monthly = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'ä»Šå¹´å£²ä¸Š',
                        data: months.map(m => monthlyData[m] || 0),
                        borderColor: '#8b1538',
                        backgroundColor: 'rgba(139, 21, 56, 0.1)',
                        borderWidth: 4,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#8b1538',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 3,
                        pointRadius: 8
                    }, {
                        label: 'å‰å¹´å£²ä¸Š',
                        data: months.map(m => monthlyPrevData[m] || 0),
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        borderWidth: 4,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3498db',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 3,
                        pointRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + (value/1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒãƒ£ãƒ¼ãƒˆ
        function updateCategoryChart() {
            const categoryData = {};
            filteredData.forEach(d => {
                if (!categoryData[d.category]) categoryData[d.category] = 0;
                categoryData[d.category] += d.sales;
            });

            if (charts.category) charts.category.destroy();
            
            const ctx = document.getElementById('categoryChart').getContext('2d');
            charts.category = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categoryData),
                    datasets: [{
                        data: Object.values(categoryData),
                        backgroundColor: [
                            '#8b1538',
                            '#3498db',
                            '#2ecc71',
                            '#f39c12',
                            '#9b59b6',
                            '#1abc9c',
                            '#e67e22',
                            '#34495e'
                        ],
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        // å‰å¹´åŒæœŸæ¯”è¼ƒãƒãƒ£ãƒ¼ãƒˆ
        function updateYoyComparisonChart() {
            const monthlyData = {};
            const monthlyPrevData = {};
            
            filteredData.forEach(d => {
                if (!monthlyData[d.date]) {
                    monthlyData[d.date] = 0;
                    monthlyPrevData[d.date] = 0;
                }
                monthlyData[d.date] += d.sales;
                monthlyPrevData[d.date] += d.prevSales || 0;
            });

            const months = ['2024-09', '2024-10', '2024-11', '2024-12', '2025-01', '2025-02'];
            const monthLabels = ['9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ', '1æœˆ', '2æœˆ'];
            const differences = months.map(m => (monthlyData[m] || 0) - (monthlyPrevData[m] || 0));

            if (charts.yoy) charts.yoy.destroy();
            
            const ctx = document.getElementById('yoyComparisonChart').getContext('2d');
            charts.yoy = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'å‰å¹´æ¯”å¢—æ¸›é¡',
                        data: differences,
                        backgroundColor: differences.map(d => d >= 0 ? 'rgba(46, 204, 113, 0.8)' : 'rgba(139, 21, 56, 0.8)'),
                        borderColor: differences.map(d => d >= 0 ? '#27ae60' : '#8b1538'),
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return 'Â¥' + (value/1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ï¼ˆæ­£ç¢ºãªãƒ‡ãƒ¼ã‚¿ï¼‰
        function updateTable() {
            const productSummary = {};
            
            filteredData.forEach(d => {
                if (!productSummary[d.product]) {
                    productSummary[d.product] = {
                        product: d.product,
                        sales: 0,
                        prevSales: 0,
                        quantity: 0,
                        category: d.category
                    };
                }
                productSummary[d.product].sales += d.sales;
                productSummary[d.product].prevSales += d.prevSales || 0;
                productSummary[d.product].quantity += d.quantity;
            });

            const products = Object.values(productSummary)
                .sort((a, b) => b.sales - a.sales)
                .slice(0, 30); // ä¸Šä½30å•†å“

            const tableBody = document.getElementById('productsTable');
            tableBody.innerHTML = '';
            
            products.forEach((product, index) => {
                const avgPrice = product.quantity > 0 ? product.sales / product.quantity : 0;
                const yoyChange = product.prevSales > 0 ? ((product.sales - product.prevSales) / product.prevSales * 100).toFixed(1) : '-';
                const row = tableBody.insertRow();
                
                // ç‰¹åˆ¥ãªè‰²ä»˜ã‘ã§ä¸Šä½å•†å“ã‚’å¼·èª¿
                let rankStyle = '';
                if (index === 0) rankStyle = 'background: linear-gradient(135deg, #f1c40f, #f39c12); color: white; font-weight: bold;';
                else if (index === 1) rankStyle = 'background: linear-gradient(135deg, #95a5a6, #7f8c8d); color: white; font-weight: bold;';
                else if (index === 2) rankStyle = 'background: linear-gradient(135deg, #e67e22, #d35400); color: white; font-weight: bold;';
                
                row.innerHTML = `
                    <td style="${rankStyle}"><strong>${index + 1}</strong></td>
                    <td class="product-name" title="${product.product}">${product.product}</td>
                    <td><strong>Â¥${product.sales.toLocaleString()}</strong></td>
                    <td>${product.quantity.toLocaleString()}å€‹</td>
                    <td>Â¥${Math.round(avgPrice).toLocaleString()}</td>
                    <td><span style="background: rgba(139, 21, 56, 0.1); padding: 3px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 500;">${product.category}</span></td>
                    <td class="${yoyChange !== '-' && parseFloat(yoyChange) >= 0 ? 'positive' : 'negative'}">${yoyChange !== '-' ? (yoyChange >= 0 ? '+' : '') + yoyChange + '%' : '-'}</td>
                `;
            });

            // ã‚«ã‚´ãƒ¡ã®é †ä½ã‚’ç‰¹åˆ¥è¡¨ç¤º
            const kagomeRank = products.findIndex(p => p.product.includes('ã‚«ã‚´ãƒ¡'));
            if (kagomeRank >= 0) {
                console.log(`ã‚«ã‚´ãƒ¡å•†å“ã¯${kagomeRank + 1}ä½ã«ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³`);
            } else {
                console.log('ã‚«ã‚´ãƒ¡å•†å“ã¯ä¸Šä½30ä½åœå¤–');
            }
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆ
        function resetFilters() {
            document.getElementById('dateFilter').value = 'all';
            document.getElementById('minSales').value = '';
            document.getElementById('maxSales').value = '';
            
            document.querySelectorAll('#categoryFilter input[type="checkbox"]').forEach(cb => cb.checked = true);
            document.querySelectorAll('#manufacturerFilter input[type="checkbox"]').forEach(cb => cb.checked = true);
            
            filteredData = [...rawData];
            updateDashboard();
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ
        window.addEventListener('load', loadRealData);
    </script>
</body>
</html>
